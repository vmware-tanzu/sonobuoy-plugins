.PHONY: build clean generate build_image help
.DEFAULT_GOAL := help

DOCKER_REGISTRY := "sonobuoy"
TAG=$(shell cat ./lib/buildinfo/version.txt)

build: clean generate ## Builds the sonolark binary
	@echo "Building the sonolark binary..."
	@go build

build_image: generate ## Builds the docker image
	@echo "Building docker image..."
	docker build -t $(DOCKER_REGISTRY)/sonolark:$(TAG) .

test: ## Runs go tests
	@echo "Running go test ./..."
	go test ./...

generate: ## Runs go generate to produce version info
	@go generate ./...

clean: ## Removes the files generated by go generate
	@echo "Removing files made by go generate..."
	@rm ./lib/buildinfo/*.txt | true

help:
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'