.PHONY: build clean gen build help kind
.DEFAULT_GOAL := help

DOCKER_REGISTRY := "sonobuoy"
TAG := "v0"
IMAGE_NAME := "e2efanout"
SONOBUOY_VERSION := "0.56.6"

sonobuoy: ## Downloads sonobuoy locally for the build
	wget https://github.com/vmware-tanzu/sonobuoy/releases/download/v$(SONOBUOY_VERSION)/sonobuoy_$(SONOBUOY_VERSION)_linux_amd64.tar.gz
	tar -xzf sonobuoy_$(SONOBUOY_VERSION)_linux_amd64.tar.gz

build: sonobuoy ## Builds the docker image
	@echo "Building docker image..."
	docker build -t $(DOCKER_REGISTRY)/$(IMAGE_NAME):$(TAG) .

plugin.yaml: ## Runs sonobuoy gen to make the plugin
	@sonobuoy gen plugin -n e2efanout -i $(DOCKER_REGISTRY)/$(IMAGE_NAME):$(TAG) --format=junit -e NUM_BUCKETS=3 > plugin.yaml

kind: ## Loads the image into local kind cluster
	kind load docker-image $(DOCKER_REGISTRY)/$(IMAGE_NAME):$(TAG)

run: plugin.yaml ## Runs the plugin
	sonobuoy run -p plugin.yaml --wait

clean: ## Removes the files generated by go generate
	@echo "Removing build files..."
	@rm ./sonobuoy | true
	@rm ./sonobuoy_$(SONOBUOY_VERSION)_linux_amd64.tar.gz* | true
	@rm ./plugin.yaml | true

help:
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'